name: Demo Remediation Workflow

# This workflow demonstrates the AI SRE Platform's automated remediation capabilities.
# It uses the local remediation action to diagnose and fix incidents in the demo application.
#
# Required GitHub Secrets:
#   - SENTRY_AUTH_TOKEN: Sentry API authentication token (create at: Settings → Account → API → Auth Tokens)
#   - SENTRY_ORG: Your Sentry organization slug (e.g., 'my-company')
#   - SENTRY_PROJECT: Your Sentry project slug (e.g., 'demo-app')
#
# Optional GitHub Variables:
#   - INCIDENT_SERVICE_URL: URL of the Incident Service for status updates (e.g., 'http://localhost:8080')
#
# To set up secrets:
#   1. Go to: Settings → Secrets and variables → Actions
#   2. Click "New repository secret"
#   3. Add each secret with the appropriate value
#
# To test the workflow:
#   1. Go to: Actions → Demo Remediation Workflow → Run workflow
#   2. Fill in the incident details
#   3. Click "Run workflow"
#   4. Monitor the workflow execution and check for the created PR

on:
  workflow_dispatch:
    inputs:
      incident_id:
        description: 'Incident ID'
        required: true
        type: string
      error_message:
        description: 'Error message'
        required: true
        type: string
      stack_trace:
        description: 'Stack trace'
        required: false
        type: string
      service_name:
        description: 'Service name'
        required: true
        type: string
      timestamp:
        description: 'Incident timestamp'
        required: true
        type: string

jobs:
  remediate:
    name: Remediate Incident
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run AI SRE Remediation
        id: remediate
        uses: ./remediation-action
        with:
          incident_id: ${{ inputs.incident_id }}
          error_message: ${{ inputs.error_message }}
          stack_trace: ${{ inputs.stack_trace }}
          service_name: ${{ inputs.service_name }}
          timestamp: ${{ inputs.timestamp }}
          incident_service_url: ${{ vars.INCIDENT_SERVICE_URL || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Sentry MCP Server credentials
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      
      - name: Output results
        run: |
          echo "Status: ${{ steps.remediate.outputs.status }}"
          echo "PR URL: ${{ steps.remediate.outputs.pr_url }}"
          echo "Diagnosis: ${{ steps.remediate.outputs.diagnosis }}"
