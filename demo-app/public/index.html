<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI SRE Demo Application</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 16px;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      margin-bottom: 30px;
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 20px;
    }

    .card h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .card p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .bug-type {
      display: inline-block;
      background: #ff6b6b;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .response {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 13px;
      font-family: 'Courier New', monospace;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }

    .response.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .response.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-indicator.healthy {
      background: #28a745;
      box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
    }

    .status-indicator.unhealthy {
      background: #dc3545;
      box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
    }

    .info-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .info-section h3 {
      color: #333;
      margin-bottom: 15px;
    }

    .info-section ul {
      list-style: none;
      padding-left: 0;
    }

    .info-section li {
      color: #666;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .info-section li:last-child {
      border-bottom: none;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Incident Status Styles */
    .incidents-panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-height: 800px;
      overflow-y: auto;
    }

    .incidents-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #999;
    }

    .refresh-indicator.active {
      color: #667eea;
    }

    .incident-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .incident-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .incident-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .incident-id {
      font-size: 12px;
      color: #999;
      font-family: 'Courier New', monospace;
    }

    .incident-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .incident-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .incident-status.workflow_triggered {
      background: #cce5ff;
      color: #004085;
    }

    .incident-status.in_progress {
      background: #d1ecf1;
      color: #0c5460;
    }

    .incident-status.pr_created {
      background: #d4edda;
      color: #155724;
    }

    .incident-status.resolved {
      background: #d4edda;
      color: #155724;
    }

    .incident-status.failed {
      background: #f8d7da;
      color: #721c24;
    }

    .incident-status.no_fix_needed {
      background: #e2e3e5;
      color: #383d41;
    }

    .incident-service {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .incident-error {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .incident-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .incident-link {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      text-decoration: none;
      color: #667eea;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .incident-link:hover {
      background: #667eea;
      color: white;
    }

    .incident-time {
      font-size: 11px;
      color: #999;
      margin-top: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    /* Dashboard iframe */
    .dashboard-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .dashboard-iframe {
      width: 100%;
      height: 600px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-top: 15px;
    }

    .view-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .view-toggle button {
      flex: 1;
      padding: 10px;
      background: #f8f9fa;
      color: #333;
    }

    .view-toggle button.active {
      background: #667eea;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ AI SRE Demo Application</h1>
      <p class="subtitle">Test the autonomous remediation system by triggering intentional bugs</p>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
      <button class="active" onclick="switchView('bugs')">üêõ Trigger Bugs</button>
      <button onclick="switchView('incidents')">üìä Incident Status</button>
      <button onclick="switchView('dashboard')">üìà Full Dashboard</button>
    </div>

    <!-- Bugs View -->
    <div id="bugs-view">
      <div class="main-layout">
        <div>
          <div class="grid">
            <!-- Bug 1: Division by Zero -->
            <div class="card">
              <span class="bug-type">Division by Zero</span>
              <h2>Average Price Calculator</h2>
              <p>Calculates average product price. Bug: Doesn't handle empty product list.</p>
              <button onclick="triggerBug1()">Trigger Bug</button>
              <div id="response1" class="response"></div>
            </div>

            <!-- Bug 2: Null Pointer -->
            <div class="card">
              <span class="bug-type">Null Pointer</span>
              <h2>User Lookup</h2>
              <p>Fetches user by ID. Bug: Doesn't check if user exists before accessing properties.</p>
              <button onclick="triggerBug2()">Trigger Bug</button>
              <div id="response2" class="response"></div>
            </div>

            <!-- Bug 3: Array Processing -->
            <div class="card">
              <span class="bug-type">Array Processing</span>
              <h2>Order Processor</h2>
              <p>Processes batch orders. Bug: Off-by-one error and missing validation.</p>
              <button onclick="triggerBug3()">Trigger Bug</button>
              <div id="response3" class="response"></div>
            </div>

            <!-- Bug 4: Type Coercion -->
            <div class="card">
              <span class="bug-type">Type Coercion</span>
              <h2>Discount Calculator</h2>
              <p>Calculates discounts. Bug: No type validation on numeric inputs.</p>
              <button onclick="triggerBug4()">Trigger Bug</button>
              <div id="response4" class="response"></div>
            </div>

            <!-- Bug 5: SQL Injection -->
            <div class="card">
              <span class="bug-type">SQL Injection</span>
              <h2>User Search</h2>
              <p>Searches users by name. Bug: String concatenation in SQL query.</p>
              <button onclick="triggerBug5()">Trigger Bug</button>
              <div id="response5" class="response"></div>
            </div>
          </div>
        </div>

        <!-- Recent Incidents Panel -->
        <div class="incidents-panel">
          <div class="incidents-header">
            <h3>Recent Incidents</h3>
            <span class="refresh-indicator" id="refresh-indicator">‚óè</span>
          </div>
          <div id="incidents-list">
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p>No incidents yet. Trigger a bug to see it here!</p>
            </div>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3>üìä System Status</h3>
        <ul>
          <li><span class="status-indicator healthy"></span>Demo Service: <strong>Running</strong></li>
          <li><span class="status-indicator" id="incident-service-indicator"></span>Incident Service: <strong id="incident-service-status">Checking...</strong></li>
          <li>Health Check: <code>GET /api/health</code></li>
          <li>Sentry Integration: <strong id="sentry-status">Checking...</strong></li>
          <li>Incident Service URL: <code id="incident-service-url">http://localhost:8080</code></li>
        </ul>
      </div>
    </div>

    <!-- Incidents View -->
    <div id="incidents-view" style="display: none;">
      <div class="card">
        <h2>All Incidents</h2>
        <div id="all-incidents-list">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No incidents found</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view" style="display: none;">
      <div class="dashboard-section">
        <h2>Full Dashboard</h2>
        <p class="subtitle">View the complete incident management dashboard</p>
        <iframe 
          id="dashboard-iframe" 
          class="dashboard-iframe" 
          src="http://localhost:3001"
          title="AI SRE Dashboard">
        </iframe>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const INCIDENT_SERVICE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:8080' 
      : 'http://incident-service:8080';
    const REFRESH_INTERVAL = 5000; // 5 seconds
    const SENTRY_DSN = ''; // Will be populated from env if available

    let currentView = 'bugs';
    let refreshTimer = null;

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      checkHealth();
      checkIncidentService();
      startAutoRefresh();
      updateIncidentServiceUrl();
    });

    function updateIncidentServiceUrl() {
      const urlElement = document.getElementById('incident-service-url');
      if (urlElement) {
        urlElement.textContent = INCIDENT_SERVICE_URL;
      }
    }

    // View switching
    function switchView(view) {
      currentView = view;
      
      // Update button states
      const buttons = document.querySelectorAll('.view-toggle button');
      buttons.forEach((btn, idx) => {
        btn.classList.remove('active');
        if ((view === 'bugs' && idx === 0) || 
            (view === 'incidents' && idx === 1) || 
            (view === 'dashboard' && idx === 2)) {
          btn.classList.add('active');
        }
      });

      // Show/hide views
      document.getElementById('bugs-view').style.display = view === 'bugs' ? 'block' : 'none';
      document.getElementById('incidents-view').style.display = view === 'incidents' ? 'block' : 'none';
      document.getElementById('dashboard-view').style.display = view === 'dashboard' ? 'block' : 'none';

      // Load data for the view
      if (view === 'incidents') {
        loadAllIncidents();
      }
    }

    // Auto-refresh incidents
    function startAutoRefresh() {
      loadRecentIncidents();
      refreshTimer = setInterval(() => {
        if (currentView === 'bugs' || currentView === 'incidents') {
          loadRecentIncidents();
          if (currentView === 'incidents') {
            loadAllIncidents();
          }
        }
      }, REFRESH_INTERVAL);
    }

    // Check demo service health
    async function checkHealth() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        console.log('Demo service health:', data);
        
        // Update Sentry status
        const sentryStatus = document.getElementById('sentry-status');
        if (sentryStatus) {
          sentryStatus.textContent = data.sentry ? 'Enabled' : 'Disabled';
        }
      } catch (error) {
        console.error('Health check failed:', error);
      }
    }

    // Check incident service health
    async function checkIncidentService() {
      try {
        const response = await fetch(`${INCIDENT_SERVICE_URL}/api/v1/health`);
        const data = await response.json();
        
        const indicator = document.getElementById('incident-service-indicator');
        const status = document.getElementById('incident-service-status');
        
        if (data.status === 'healthy') {
          indicator.classList.add('healthy');
          indicator.classList.remove('unhealthy');
          status.textContent = 'Connected';
        } else {
          indicator.classList.add('unhealthy');
          indicator.classList.remove('healthy');
          status.textContent = 'Degraded';
        }
      } catch (error) {
        console.error('Incident service check failed:', error);
        const indicator = document.getElementById('incident-service-indicator');
        const status = document.getElementById('incident-service-status');
        indicator.classList.add('unhealthy');
        indicator.classList.remove('healthy');
        status.textContent = 'Disconnected';
      }
    }

    // Load recent incidents (for sidebar)
    async function loadRecentIncidents() {
      const indicator = document.getElementById('refresh-indicator');
      indicator.classList.add('active');

      try {
        const response = await fetch(`${INCIDENT_SERVICE_URL}/api/v1/incidents`);
        const data = await response.json();
        
        const incidents = data.incidents || [];
        const recentIncidents = incidents.slice(0, 5); // Show only 5 most recent
        
        renderIncidents('incidents-list', recentIncidents);
      } catch (error) {
        console.error('Failed to load incidents:', error);
      } finally {
        indicator.classList.remove('active');
      }
    }

    // Load all incidents (for incidents view)
    async function loadAllIncidents() {
      try {
        const response = await fetch(`${INCIDENT_SERVICE_URL}/api/v1/incidents`);
        const data = await response.json();
        
        const incidents = data.incidents || [];
        renderIncidents('all-incidents-list', incidents);
      } catch (error) {
        console.error('Failed to load all incidents:', error);
      }
    }

    // Render incidents list
    function renderIncidents(containerId, incidents) {
      const container = document.getElementById(containerId);
      
      if (!incidents || incidents.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No incidents found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = incidents.map(incident => {
        const createdAt = new Date(incident.created_at);
        const timeAgo = getTimeAgo(createdAt);
        
        // Build links
        let linksHtml = '';
        if (incident.pull_request_url) {
          linksHtml += `<a href="${incident.pull_request_url}" target="_blank" class="incident-link">üîó Pull Request</a>`;
        }
        
        // Add Sentry link if available
        if (incident.provider === 'sentry' && incident.provider_data && incident.provider_data.issue_url) {
          linksHtml += `<a href="${incident.provider_data.issue_url}" target="_blank" class="incident-link">üêõ Sentry Issue</a>`;
        }
        
        // Add provider link for other providers
        if (incident.provider_data) {
          if (incident.provider === 'datadog' && incident.provider_data.snapshot_url) {
            linksHtml += `<a href="${incident.provider_data.snapshot_url}" target="_blank" class="incident-link">üìä Datadog</a>`;
          } else if (incident.provider === 'pagerduty' && incident.provider_data.incident_url) {
            linksHtml += `<a href="${incident.provider_data.incident_url}" target="_blank" class="incident-link">üìü PagerDuty</a>`;
          }
        }

        return `
          <div class="incident-item">
            <div class="incident-header">
              <span class="incident-id">${incident.id}</span>
              <span class="incident-status ${incident.status}">${incident.status.replace(/_/g, ' ')}</span>
            </div>
            <div class="incident-service">${incident.service_name}</div>
            <div class="incident-error">${truncate(incident.error_message, 100)}</div>
            ${linksHtml ? `<div class="incident-links">${linksHtml}</div>` : ''}
            <div class="incident-time">${timeAgo}</div>
          </div>
        `;
      }).join('');
    }

    // Utility functions
    function truncate(str, length) {
      if (!str) return '';
      return str.length > length ? str.substring(0, length) + '...' : str;
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return `${seconds}s ago`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    function showResponse(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.textContent = JSON.stringify(data, null, 2);
      element.className = isError ? 'response error' : 'response success';
      
      // Refresh incidents after triggering a bug
      setTimeout(() => {
        loadRecentIncidents();
      }, 2000);
    }

    // Bug trigger functions
    async function triggerBug1() {
      try {
        const response = await fetch('/api/buggy/average-price');
        const data = await response.json();
        showResponse('response1', data, !response.ok);
      } catch (error) {
        showResponse('response1', { error: error.message }, true);
      }
    }

    async function triggerBug2() {
      try {
        const response = await fetch('/api/buggy/user/999');
        const data = await response.json();
        showResponse('response2', data, !response.ok);
      } catch (error) {
        showResponse('response2', { error: error.message }, true);
      }
    }

    async function triggerBug3() {
      try {
        const response = await fetch('/api/buggy/process-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            orders: [
              { userId: 1, productId: 1, quantity: 2 },
              { userId: 2, productId: 2, quantity: 1 }
            ]
          })
        });
        const data = await response.json();
        showResponse('response3', data, !response.ok);
      } catch (error) {
        showResponse('response3', { error: error.message }, true);
      }
    }

    async function triggerBug4() {
      try {
        const response = await fetch('/api/buggy/calculate-discount', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            price: "100",
            discountPercent: "20"
          })
        });
        const data = await response.json();
        showResponse('response4', data, !response.ok);
      } catch (error) {
        showResponse('response4', { error: error.message }, true);
      }
    }

    async function triggerBug5() {
      try {
        const response = await fetch('/api/buggy/search-users?name=Alice\'');
        const data = await response.json();
        showResponse('response5', data, !response.ok);
      } catch (error) {
        showResponse('response5', { error: error.message }, true);
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshTimer) {
        clearInterval(refreshTimer);
      }
    });
  </script>
</body>
</html>
